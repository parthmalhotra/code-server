name: Build and Release

on:
  push:
    tags:
      - "v*" # Triggers on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"

jobs:
  # First, build the base npm package
  build:
    name: Build code-server
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y libkrb5-dev quilt

      - name: Apply patches
        run: quilt push -a

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: SKIP_SUBMODULE_DEPS=1 npm ci

      - name: Build code-server
        run: npm run build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build VS Code
        run: |
          pushd lib/vscode
          npm ci
          popd
          npm run build:vscode
        env:
          VERSION: "0.0.0"
          # Skip downloading Electron binary - not needed for browser-based code-server
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          # Skip downloading Playwright browsers - not needed for build
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Create release bundle
        run: npm run release

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Extract version from tag (v1.0.0 -> 1.0.0)
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version in package.json
        run: |
          npm version --prefix release "${{ steps.version.outputs.version }}" --no-git-tag-version || true

      - name: Package release
        run: tar -czf package.tar.gz release

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: ./package.tar.gz
          retention-days: 7

  # Build Linux binaries
  build-linux:
    name: Build Linux ${{ matrix.arch }}
    runs-on: ubuntu-22.04
    needs: build
    timeout-minutes: 30
    strategy:
      matrix:
        include:
          - arch: amd64
            npm_arch: x64
            prefix: x86_64-linux-gnu
          - arch: arm64
            npm_arch: arm64
            prefix: aarch64-linux-gnu

    env:
      AR: ${{ matrix.prefix }}-ar
      CC: ${{ matrix.prefix }}-gcc
      CXX: ${{ matrix.prefix }}-g++
      npm_config_arch: ${{ matrix.npm_arch }}
      npm_config_build_from_source: true
      VERSION: ${{ needs.build.outputs.version }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install cross-compiler and dependencies
        run: |
          # For arm64 cross-compilation, we need to add the ports.ubuntu.com mirror
          # since the main Ubuntu mirrors don't have arm64 packages on amd64 hosts
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            # Add arm64 architecture
            sudo dpkg --add-architecture arm64
            
            # Add ports.ubuntu.com as source for arm64 packages
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm64.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm64.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm64.list
            
            # Restrict the main sources to amd64 only to avoid conflicts
            sudo sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          fi
          
          sudo apt update
          sudo apt install -y \
            crossbuild-essential-${{ matrix.arch }} \
            libx11-dev:${{ matrix.arch }} \
            libxkbfile-dev:${{ matrix.arch }} \
            libsecret-1-dev:${{ matrix.arch }} \
            libkrb5-dev:${{ matrix.arch }} \
            rsync

      - name: Install nfpm
        run: |
          curl -sSfL https://github.com/goreleaser/nfpm/releases/download/v2.35.3/nfpm_2.35.3_linux_amd64.tar.gz | sudo tar -C /usr/local/bin -zxv nfpm

      - name: Install npm dependencies
        run: SKIP_SUBMODULE_DEPS=1 npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: npm-package

      - name: Extract package
        run: tar -xzf package.tar.gz

      - name: Build standalone release
        run: npm run release:standalone

      - name: Replace node binary with correct architecture
        run: |
          node_version=$(node --version)
          wget -q "https://nodejs.org/dist/${node_version}/node-${node_version}-linux-${{ matrix.npm_arch }}.tar.xz"
          tar -xf "node-${node_version}-linux-${{ matrix.npm_arch }}.tar.xz" "node-${node_version}-linux-${{ matrix.npm_arch }}/bin/node" --strip-components=2
          mv ./node ./release-standalone/lib/node

      - name: Build packages
        run: npm run package ${{ matrix.arch }}

      - name: Upload release packages
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-linux-${{ matrix.arch }}
          path: ./release-packages/*
          retention-days: 7

  # Create GitHub Release
  release:
    name: Create GitHub Release
    runs-on: ubuntu-22.04
    needs: [build, build-linux]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.deb" -o -name "*.rpm" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.build.outputs.version }}
          tag_name: v${{ needs.build.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
